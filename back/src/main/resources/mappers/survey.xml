<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="survey">
    <select id="findById" parameterType="String" resultType="Survey_MySQL">
        select *
        from survey
        where _id = #{_id};
    </select>

    <select id="selectSurveyList" parameterType="PaginationInfo_MySQL" resultType="Survey_MySQL">
        select survey._id, survey.Sur_Title, survey.Sur_Content, survey.Sur_State, survey.Sur_StartDate, survey.Sur_EndDate, survey.Sur_Publish, survey.Sur_Img, survey.User_Email, survey.Sur_Type, surveytag.Tag_ID
        from survey left OUTER JOIN surveytag
        on survey._id = surveytag._id
        where Sur_Publish = true
        and (survey.Sur_State = 1 or survey.Sur_State = 2)
        <if test="criteria.search_Key != null">
            and  survey.Sur_Title like CONCAT("%", #{criteria.search_Key}, "%")
        </if>
        <if test="criteria.search_Tag != null">
            and  surveytag.Tag_ID = #{criteria.search_Tag}
        </if>
        <if test="criteria.user_Email != null">
            and survey.User_Email = #{criteria.user_Email}
        </if>
        group by survey._id
        order by survey.Sur_State
        limit #{firstRecordIndex}, #{criteria.records_Perpage};
    </select>

    <select id="selectSurveyTotalCount" parameterType="Criteria_MySQL" resultType="int">
        select count(survey._id)
        from survey left OUTER JOIN surveytag
        on survey._id = surveytag._id
        where Sur_Publish = true
        and (survey.Sur_State = 1 or survey.Sur_State = 2)
        <if test="search_Key != null">
            and survey.Sur_Title like CONCAT("%", #{search_Key}, "%")
        </if>
        <if test="search_Tag != null">
            and surveytag.Tag_ID = #{search_Tag}
        </if>
        <if test="user_Email != null">
            and survey.User_Email = #{user_Email}
        </if>
        ;
    </select>

<!--    <select id="selectMySurveyList" resultType="Survey_MySQL" parameterType="String">-->
<!--        select *-->
<!--        from survey-->
<!--        where User_Email = #{User_Email}-->
<!--    </select>-->

    <insert id="insertSurvey" parameterType="Survey_MySQL">
        insert into survey values (#{_id},#{sur_Title},#{sur_Content},#{sur_State},#{sur_StartDate},#{sur_EndDate},#{sur_Publish},#{sur_Image},#{user_Email},#{sur_Type} );
    </insert>

    <select id="selectOwner" parameterType="String" resultType="String">
        select User_Email from survey where _id = #{_id};
    </select>

    <delete id="deleteSurvey" parameterType = "String">
        delete from Survey where _id = #{_id};
    </delete>

    <update id="updateSurvey" parameterType = "Survey_MySQL">
        update survey
        set Sur_Title = #{sur_Title}, Sur_Content = #{sur_Content}, Sur_State = #{sur_State},
            Sur_StartDate = #{sur_StartDate}, Sur_EndDate = #{sur_EndDate},
            Sur_Publish = #{sur_Publish}, Sur_Image = #{sur_Image},
            User_Email = #{user_Email}, Sur_Type = #{sur_Type}
        where _id = #{_id}
    </update>

    <select id="todaystartlist" resultType="Survey_MySQL">
        select User_Email from survey;
    </select>

</mapper>

